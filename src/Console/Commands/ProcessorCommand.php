<?php
// +----------------------------------------------------------------------
// | Created by linshan. 版权所有 @
// +----------------------------------------------------------------------
// | Copyright (c) 2020 All rights reserved.
// +----------------------------------------------------------------------
// | Technology changes the world . Accumulation makes people grow .
// +----------------------------------------------------------------------
// | Author: kaka梦很美 <1099013371@qq.com>
// +----------------------------------------------------------------------

namespace ShugaChara\Framework\Console\Commands;

use RuntimeException;
use ShugaChara\Console\Command;
use ShugaChara\Framework\Contracts\StatusManagerInterface;
use ShugaChara\Framework\Helpers\FHelper;
use ShugaChara\Swoole\Contracts\ProcessorAbstract;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use swoole_process;

/**
 * Class ProcessorCommand
 * @package ShugaChara\Framework\Console\Commands
 */
class ProcessorCommand extends Command implements StatusManagerInterface
{
    protected static $name = 'processor';

    /**
     * 字符串替换占位符
     * @var string
     */
    private $placeholder = '#placeholder#';

    /**
     * 获取所有注册进程
     * @var array
     */
    protected $processes = [];

    /**
     * 当前进程
     * @var ProcessorAbstract
     */
    protected $process;

    /**
     * 进程名称
     * @var
     */
    protected $process_name;

    /**
     * process pid 目录
     * @var
     */
    protected $pid_path;

    /**
     * process pid 文件
     * @var
     */
    protected $pid_file;

    /**
     * process 配置项
     * @var array
     */
    protected $options = [];

    /**
     * 是否守护进程运行
     * @var bool
     */
    protected $daemon = false;

    /**
     * ProcessorCommand constructor.
     * @param string|null $name
     */
    public function __construct(string $name = null)
    {
        parent::__construct($name);
    }

    protected function configure()
    {
        parent::configure(); // TODO: Change the autogenerated stub

        $this
            ->setName(self::$name)// 命令的名称
            ->setDescription('单独运行一个 Swoole 进程')// 简短描述
            ->addArgument('process_name', InputArgument::OPTIONAL, '进程名称')
            ->addArgument('status', InputArgument::OPTIONAL, '进程服务状态')
            ->addOption('daemon', '-d', InputOption::VALUE_NONE, '守护进程')
            ->addOption('list', '-l', InputOption::VALUE_NONE, '查看进程列表');
    }

    /**
     * @param InputInterface  $input
     * @param OutputInterface $output
     * @return int
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $this->process_name = strtolower($input->getArgument('process_name'));
        $status = strtolower($input->getArgument('status')) ? : self::STATUS_NAME;
        $this->daemon = $input->hasParameterOption(['--daemon', '-d'], true) ? true : false;
        if (in_array($status, self::STATUS_TYPES)) {
            $this->pid_path = FHelper::c()->get('swoole.processor.pid_path');
            if (! file_exists($this->pid_path)) {
                mkdir($this->pid_path, 0755, true);
            }

            $this->pid_file = $this->pid_path . '/' . ($this->process_name ? : $this->placeholder) . '.pid';

            if ($input->hasParameterOption(['--list', '-l']) || empty($this->process_name)) {
                $this->showProcesses($input, $output);
                return 1;
            }

            $this->processes = c()->get('processor', []);
            if (! isset($this->processes[$this->process_name])) {
                throw new RuntimeException(sprintf('Process %s cannot found', $this->process_name));
            }
            $config = $this->processes[$this->process_name];
            $processClassName = $config['process'];
            if (! class_exists($processClassName)) {
                throw new RuntimeException(sprintf('Process class "%s" is not found.', $this->process_name));
            }

            $this->options = isset($config['options']) ? (array) $config['options'] : [];
            $this->process = new $processClassName($this->process_name);
            if (! ($this->process instanceof ProcessorAbstract)) {
                throw new RuntimeException('Process must be instance of \ShugaChara\Swoole\Manager\Processor');
            }
            if ($input->hasParameterOption(['--daemon', '-d'])) {
                $this->process->getProcessor()->daemon();
            }

            $this->$status();

            return 1;
        }

        throw new Exception($status . ' swoole processor 状态未定义,请通过 --help 查看命令');
    }

    /**
     * @return mixed|void
     */
    public function status()
    {
        // TODO: Implement status() method.

        $info = $this->getProcessInfo($this->process_name);
        $rows[] = [
            $this->process_name,
            get_class($this->process),
            $info[2],
            $info[1]
        ];
        foreach ($this->options as $key => $value) {
            $rows[] = ['options.' . $key, sprintf('<info>%s</info>', $value)];
        }

        $this->table(
            [
                'NAME', 'CLASS', 'STATUS', 'PID'
            ],
            $rows
        );
    }

    /**
     * @return mixed|void
     * @throws \Exception
     */
    public function start()
    {
        // TODO: Implement start() method.

        $pid = $this->process->getProcessor()->start();
        file_put_contents($this->pid_file, $pid);
        $this->info(sprintf('process <info>%s</info> PID: <info>%s</info>', $this->process_name, $pid));
        $this->info(sprintf('PID: <info>%s</info>', $this->pid_file));
        $this->process->getProcessor()->wait(true, function ($ret) {
            return $this->finish($this->process_name, $ret['pid'], $ret['code'], $ret['signal']);
        });
    }

    /**
     * @return mixed|void
     */
    public function stop()
    {
        // TODO: Implement stop() method.

        $pid = (int) file_get_contents($this->pid_file);
        if ($this->process->getProcessor()->kill($pid, SIGTERM)) {
            $this->info(sprintf('process %s PID %s is killed', $this->process_name, $pid));
        }
    }

    /**
     * @return mixed|void
     */
    public function reload()
    {
        // TODO: Implement reload() method.
    }

    /**
     * @return mixed|void
     */
    public function restart()
    {
        // TODO: Implement restart() method.

        $this->stop();

        $this->start();
    }

    /**
     * 查看进程列表
     */
    protected function showProcesses()
    {
        $rows = [];
        foreach (FHelper::c()->get('processor', []) as $name => $processor) {
            $rows[] = $this->getProcessInfo($name);
        }

        $this->table(
            [
                'PROCESS', 'PID', 'STATUS', 'START AT', 'RUNTIME'
            ],
            $rows
        );
    }

    /**
     * 获取进程详情
     * @param $process_name
     * @return array
     */
    protected function getProcessInfo($process_name)
    {
        $isRunning = false;
        $pid_file = str_replace($this->placeholder, $process_name, $this->pid_file);
        $pid = file_exists($pid_file) ? (int) file_get_contents($pid_file) : '';
        if (is_numeric($pid)) {
            $isRunning = swoole_process::kill($pid, 0);
        }

        return [
            $process_name,
            $isRunning ? $pid : '',
            $isRunning ? '运行中' : '已停止',
            $isRunning ? date('Y-m-d H:i:s', filemtime($pid_file)) : '',
            $isRunning ? time() - filemtime($pid_file) : '',
        ];
    }

    /**
     * @param     $process_name
     * @param     $pid
     * @param int $code
     * @param int $signal
     */
    protected function finish($process_name, $pid, $code = 0, $signal = 0)
    {
        $this->info(sprintf('process: %s. PID: %s exit. code: %s. signal: %s', $process_name, $pid, $code, $signal));
    }
}

