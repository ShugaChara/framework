<?php
// +----------------------------------------------------------------------
// | Created by linshan. 版权所有 @
// +----------------------------------------------------------------------
// | Copyright (c) 2019 All rights reserved.
// +----------------------------------------------------------------------
// | Technology changes the world . Accumulation makes people grow .
// +----------------------------------------------------------------------
// | Author: kaka梦很美 <1099013371@qq.com>
// +----------------------------------------------------------------------

namespace ShugaChara\Framework\Console\Commands;

use Exception;
use ShugaChara\Framework\Constant\Consts;
use ShugaChara\Framework\Exceptions\SwooleServerException;
use ShugaChara\Framework\Server\SwooleServer;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;

/**
 * Class HttpServerCommand
 * @package ShugaChara\Framework\Console\Commands
 */
class HttpServerCommand extends BaseServerCommand
{
    protected static $name = 'http';

    protected function configure()
    {
        parent::configure(); // TODO: Change the autogenerated stub

        $this
            ->setName(self::$name)  // 命令的名称
            ->setDescription('创建一个swoole ' . self::$name . ' 服务器')  // 简短描述
            ->setHelp($this->help())  // 运行命令时使用 "--help" 选项时的完整命令描述
            ->addArgument('handle', InputArgument::OPTIONAL, '服务状态');
    }

    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $handle = strtolower($input->getArgument('handle')) ?? Consts::SWOOLE_SERVER_STATUS_NAME;
        if (in_array($handle, $this->handleType)) {
            $serverConfig = config()->get('swoole.http') ?? [];
            $this->server = SwooleServer::getInstance()->initAppSwooleServer(
                Consts::SWOOLE_SERVER_HTTP,
                $serverConfig,
                $output
            );
            $this->$handle();

            return true;
        }

        throw new Exception($handle . ' 服务状态未定义,请通过 --help 查看命令');
    }

    public function status()
    {
        // TODO: Implement status() method.

        $swooleServer = $this->getSwooleServer();
        if (! $swooleServer->status()) {
            $swooleServer->consoleOutput->writeln(sprintf('Server <info>%s</info> is not running...', $swooleServer->getAppSwooleServerName()));
            return false;
        }

        return true;
    }

    public function start()
    {
        // TODO: Implement start() method.

        $swooleServer = $this->getSwooleServer();
        if ($swooleServer->status()) {
            return false;
        }

        return $swooleServer->start();
    }

    public function stop()
    {
        // TODO: Implement stop() method.

        $swooleServer = $this->getSwooleServer();
        if (! $swooleServer->status()) {
            return false;
        }

        return $swooleServer->stop();
    }

    public function reload()
    {
        // TODO: Implement reload() method.

        $swooleServer = $this->getSwooleServer();
        if (! $swooleServer->status()) {
            return false;
        }

        return $swooleServer->reload();
    }

    public function restart()
    {
        // TODO: Implement restart() method.

        $swooleServer = $this->getSwooleServer();
        if (! $swooleServer->status()) {
            return false;
        }

        return $swooleServer->restart();
    }

    /**
     * 完整命令描述
     * @return string
     */
    public function help(): string
    {
        return '创建一个http服务器';
    }
}

